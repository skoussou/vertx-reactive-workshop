= SCENARIO

image:images/Visual-Scenario.png["VertX Application Scenario",height=712] 

== The Micro-Homeplan Application

This is a short description of the scenario we will be working throughout the labs

Itâ€™s going to be a fake home appliance IOT management app, where we will be able to regulate the temperature in different rooms at our home. The application is composed of a set of microservices:

* The *_homeplan_* - this is a service which allows home owners to register and review their homeplan providing the temperature in each of the rooms in their house and the heat regulating applicances in each room. 

* The *_device management_* - this is a component which receives registration and update requests on the devices.

*  The *_sensor generator_* - this is a ficticious service emitting every 20 secs an event indicating the room temperature dependent on the state of the heating device (ON/OFF and INCREASING/DECREASING temperature)

* The *_homeplan regulator_* - this is a service which reads our current homeplan and based on the emmitted temperature in the room it regulates the action a device has to take to enforece the plan ie. INCREASE, DECREASE temperature of TURNOFF the device.

== Design
image:images/design.png["VertX Application",height=356] 

= LAB 4

TIME ESTIMATION 30 MINUTES
FOLLOWED by 15 MINUTES reviewing the solution

== Concepts visited in this LAB

* http://vertx.io/docs/vertx-core/java/#event_bus[The EventBus] sending/consuming messages over a clustered bus with publish pattern
* Starting multiple Verticles consuming the publish message and see what outcome of consuming is
* *TBC* Use Vert.x http://vertx.io/docs/#reactive[JavaRX API]
* *TBC*Observable ??



== PARTICIPANTS

In this lab we finalise the scenario by enhancing sensor-generator to _publish_ ambiance data of a room (sensorLocation) into the EventBus and introduce a new Vert.x Microservice: the *_homeplan-regulator_*. 

The new microservice will listen for ambiance data and send a request/reply from *_homeplan_* for the homeplan the ambiance data belong to combining the knowledge to send a _device action_ on the EventBus. 

The *_device-management_* will be enhanced to consume _device action_ messages and published _ambiance data_ for the purpose of updating a device with the action to take and the current room temperature.

image:images/LAB-4.png["Lab Scenario Intentions",height=712] 

==== STEP 1 - Start a clustered Vert.x application
* clone/unzip https://github.com/skoussou/vertx-reactive-workshop Branch *LAB 4*
* Run the following command to initiate a clustered Vert.X application and you should see the relevant message to indicate clustering has taken place with 4 members

----
open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/homeplan
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/device-management
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/sensor-generator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/homeplan-regulator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"
----


==== STEP 2 - Create content for the following parts of the scenario

* Create Content for verticles in *_sensor-generator_* maven project to complete the service
  ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API] Fix method *_sendAmbianceData(DeviceStatusDTO deviceStatus, HomePlanDTO homePlan)_* in *_MainVerticle.java_* to publish the generated ambiance data of a location in the house on EventBus address *_#ambiance-data_*
    *** It will be tested with the following changes

* Create Content for verticles in *_homeplan-regulator_* maven project to complete the service
  ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API] Fix method *_startHomeplanRegulatorEventBusProvider()_* in *_MainVerticle.java_* to consume messages published on *_#ambiance-data_* and extract the sensor reading
     *** As soon as this is completed and saved the redeployment will result on an error to appear at the console log for *_homeplan-regulator_* if there would be any homplan created. If not, create one as explained below.

----
SEVERE: 401: HOMEPLAN_REGULATOR_FAIL_APPLY_HOMEPLAN Homeplan Regulation Error
[INFO] io.vertx.core.impl.NoStackTraceThrowable: FIXME - Missing solution to send the HomePlan Regulator decision on device [SENSOR-LOCATION-DEVICE-ID]
----

   ** Using resources at link:http://vertx.io/docs/vertx-core/java/#_the_event_bus_api[Vert.x EventBus API]  Fix method *_sendRegulatoryMsg_* to generate a message  which can be delivered to *_#device-action_* EventBus address to signify different actions on a device INCREASING/DECREASING/TURNOFF. Hint: Setting headers on messages

----
open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/homeplan
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/device-management
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/sensor-generator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/homeplan-regulator
mvn compile vertx:run -Dvertx.runArgs="-cluster -Djava.net.preferIPv4Stack=true"

open new terminal
cd [REPOSITORY CLONED DIR - Branch LAB-4]/homeplan/data
curl -H "Content-Type: application/json" -X POST -d '@test3.json'  http://127.0.0.1:8080/homeplan/test3
----

     ====== TESTS
        **** Test 1: Use the tests above and follow logs to see that the temperature increases/decreases depending on PLAN and sensor data. See an indicative log below and notice the homeplan 
                     desired temperature *22* and the ambiance *35* originally changing to *34*, *33* as the device action has been set to *DECREASING* on device *_test3-kitchen-1_* and the
                     sensor generator senses this changing the temperature in the room every 30 secs by 1 degree until homeplan and ambiance match. Watch also device-management logs which apply these actions.

----
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR EVENT BUS ready (Vert.X EventLoop com.redhat.consulting.vertx.MainVerticle@5e07ca61) 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 12:50:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Begin Regulating Location test3-SensorLocation [id=kitchen-1, type=kitchen, temperature=35]
[INFO] Sep 07, 2017 12:50:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Finding match between ambiance data [test3-kitchen-1] and sensor location [test3-kitchen-1]
[INFO] Sep 07, 2017 12:50:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: AMBIANCE{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 35
[INFO] }
[INFO] PLAN{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 22
[INFO] }
[INFO] Sep 07, 2017 12:50:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applying Temperature HomePlan for PLAN TEMP [22 Location TEMP [35] 
[INFO] Sep 07, 2017 12:50:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Sending Regulating action <DECREASING> on Device: {
[INFO]   "housePlanId" : "test3",
[INFO]   "id" : "kitchen-1"
[INFO] }
[INFO] Sep 07, 2017 12:50:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applied Successfully HomePlan temperature regulation for location test3-kitchen-1
[INFO] Sep 07, 2017 12:50:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: 
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR EVENT BUS ready (Vert.X EventLoop com.redhat.consulting.vertx.MainVerticle@5e07ca61) 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 12:50:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Begin Regulating Location test3-SensorLocation [id=kitchen-1, type=kitchen, temperature=34]
[INFO] Sep 07, 2017 12:50:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Finding match between ambiance data [test3-kitchen-1] and sensor location [test3-kitchen-1]
[INFO] Sep 07, 2017 12:50:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: AMBIANCE{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 34
[INFO] }
[INFO] PLAN{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 22
[INFO] }
[INFO] Sep 07, 2017 12:50:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applying Temperature HomePlan for PLAN TEMP [22 Location TEMP [34] 
[INFO] Sep 07, 2017 12:50:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Sending Regulating action <DECREASING> on Device: {
[INFO]   "housePlanId" : "test3",
[INFO]   "id" : "kitchen-1"
[INFO] }
[INFO] Sep 07, 2017 12:50:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applied Successfully HomePlan temperature regulation for location test3-kitchen-1
[INFO] Sep 07, 2017 12:50:57 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: 
[INFO] ----------------------------------------------------------------------------

[... HERE WE HAVE REMOVED 30 secs of logging ..]

[INFO] INFO: 
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR EVENT BUS ready (Vert.X EventLoop com.redhat.consulting.vertx.MainVerticle@5e07ca61) 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 12:51:27 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Begin Regulating Location test3-SensorLocation [id=kitchen-1, type=kitchen, temperature=33]
[INFO] Sep 07, 2017 12:51:27 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Finding match between ambiance data [test3-kitchen-1] and sensor location [test3-kitchen-1]
[INFO] Sep 07, 2017 12:51:27 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: AMBIANCE{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 33
[INFO] }
[INFO] PLAN{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 22
[INFO] }
[INFO] Sep 07, 2017 12:51:27 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applying Temperature HomePlan for PLAN TEMP [22 Location TEMP [33] 
[INFO] Sep 07, 2017 12:51:27 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Sending Regulating action <DECREASING> on Device: {
[INFO]   "housePlanId" : "test3",
[INFO]   "id" : "kitchen-1"
[INFO] }
[INFO] Sep 07, 2017 12:51:27 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applied Successfully HomePlan temperature regulation for location test3-kitchen-1
----

        **** Ensure device is turned-off when homeplan temperature in that sensorLocation is reached and see it in the log where now the action on the device will be *TURNOFF* (see also device-management logs which apply this action).

----
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR EVENT BUS ready (Vert.X EventLoop com.redhat.consulting.vertx.MainVerticle@5e07ca61) 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 12:58:17 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Begin Regulating Location test3-SensorLocation [id=kitchen-1, type=kitchen, temperature=22]
[INFO] Sep 07, 2017 12:58:17 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Finding match between ambiance data [test3-kitchen-1] and sensor location [test3-kitchen-1]
[INFO] Sep 07, 2017 12:58:17 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: AMBIANCE{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 22
[INFO] }
[INFO] PLAN{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 22
[INFO] }
[INFO] Sep 07, 2017 12:58:17 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applying Temperature HomePlan for PLAN TEMP [22 Location TEMP [22] 
[INFO] Sep 07, 2017 12:58:17 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Sending Regulating action <TURNOFF> on Device: {
[INFO]   "housePlanId" : "test3",
[INFO]   "id" : "kitchen-1"
[INFO] }
[INFO] Sep 07, 2017 12:58:17 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applied Successfully HomePlan temperature regulation for location test3-kitchen-1

----

        **** Change homeplan via a modification of test3.json and resubmit via PUT Rest request on the same endpoint. You should see the homeplan changing and the sensor-generator reacting in flight
             with new ambiance data whilst also the homeplan-regulator also changes behavior on the device actions
        **** Start homeplan-regulator Verticle with --instances=2 parameter ---> What happens? does homeplan-regulator Verticle instances both consume it? (It shouldn't be, it should be one)

----
[INFO] Members [4] {
[INFO] 	Member [192.168.122.1]:5701
[INFO] 	Member [192.168.122.1]:5702
[INFO] 	Member [192.168.122.1]:5704
[INFO] 	Member [192.168.122.1]:5703 this
[INFO] }
[INFO] 
[INFO] Sep 07, 2017 1:04:37 PM com.hazelcast.core.LifecycleService
[INFO] INFO: [192.168.122.1]:5703 [dev] [3.6.3] Address[192.168.122.1]:5703 is STARTED
[INFO] Sep 07, 2017 1:04:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: 
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR - MainVerticle 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 1:04:38 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: 
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR - MainVerticle 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 1:04:38 PM io.vertx.core.impl.launcher.commands.VertxIsolatedDeployer
[INFO] INFO: Succeeded in deploying verticle
[INFO] Sep 07, 2017 1:04:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: 
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR EVENT BUS ready (Vert.X EventLoop com.redhat.consulting.vertx.MainVerticle@41674304) 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 1:04:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: 
[INFO] ----------------------------------------------------------------------------
[INFO]  HOMEPLAN REGULATOR EVENT BUS ready (Vert.X EventLoop com.redhat.consulting.vertx.MainVerticle@19014d32) 
[INFO] ----------------------------------------------------------------------------
[INFO] Sep 07, 2017 1:04:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Begin Regulating Location test3-SensorLocation [id=kitchen-1, type=kitchen, temperature=21]
[INFO] Sep 07, 2017 1:04:47 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Begin Regulating Location test3-SensorLocation [id=kitchen-1, type=kitchen, temperature=21]
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Finding match between ambiance data [test3-kitchen-1] and sensor location [test3-kitchen-1]
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: AMBIANCE{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 21
[INFO] }
[INFO] PLAN{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 38
[INFO] }
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applying Temperature HomePlan for PLAN TEMP [38 Location TEMP [21] 
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Sending Regulating action <INCREASING> on Device: {
[INFO]   "housePlanId" : "test3",
[INFO]   "id" : "kitchen-1"
[INFO] }
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Finding match between ambiance data [test3-kitchen-1] and sensor location [test3-kitchen-1]
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: AMBIANCE{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 21
[INFO] }
[INFO] PLAN{
[INFO]   "id" : "kitchen-1",
[INFO]   "type" : "kitchen",
[INFO]   "temperature" : 38
[INFO] }
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applying Temperature HomePlan for PLAN TEMP [38 Location TEMP [21] 
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Sending Regulating action <INCREASING> on Device: {
[INFO]   "housePlanId" : "test3",
[INFO]   "id" : "kitchen-1"
[INFO] }
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applied Successfully HomePlan temperature regulation for location test3-kitchen-1
[INFO] Sep 07, 2017 1:04:48 PM com.redhat.consulting.vertx.MainVerticle
[INFO] INFO: Applied Successfully HomePlan temperature regulation for location test3-kitchen-1
----



        **** Start an additional homeplan-regulator Vert.x node  What happens?





==== STEP 3 - Modify Content to utilize Vert.x JavaRX API (ALL THESE STEPS ARE OPTIONAL)

*TBD*

