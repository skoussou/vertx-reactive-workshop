= SCENARIO

image:images/Visual-Scenario.png["VertX Application Scenario",height=712] 

== The Micro-Homeplan Application

This is a short description of the scenario we will be working throughout the labs

Itâ€™s going to be a fake home appliance IOT management app, where we will be able to regulate the temperature in different rooms at our home. The application is composed of a set of microservices:

* The *_homeplan_* - this is a service which allows home owners to register and review their homeplan providing the temperature in each of the rooms in their house and the heat regulating applicances in each room. 

* The *_device management_* - this is a component which receives registration and update requests on the devices.

* The *_sensor generator_* - this is a ficticious service emitting every 20 secs an event indicating the room temperature dependent on the state of the heating device (ON/OFF and INCREASING/DECREASING temperature)

* The *_homeplan regulator_* - this is a service which reads our current homeplan and based on the emmitted temperature in the room it regulates the action a device has to take to enforece the plan ie. INCREASE, DECREASE temperature of TURNOFF the device.

== Design
image:images/design.png["VertX Application",height=356

= LAB 1

TIME ESTIMATION 30 MINUTES
FOLLOWED by 15 MINUTES explain the solution


== Concepts visited in this LAB

- http://vertx.io/docs/vertx-core/java/#_verticles[Verticle and instances]
- http://vertx.io/docs/vertx-core/java/#_writing_http_servers_and_clients[HTTPServer]
- http://vertx.io/docs/vertx-core/java/#_reactor_and_multi_reactor[EventLoop]
- http://vertx.io/docs/vertx-core/java/#_verticles[Launcher]Launcher


== Participants

image:images/LAB-1.png["Lab Scenario Intentions",height=712] 

[source,perl]

==== STEP 1 - Create a Vert.x maven project with the following command initiating it with a single Vert.x Verticle using a Vert.x maven archetype

[source,perl]
----
mvn io.fabric8:vertx-maven-plugin:1.0.9:setup -DprojectGroupId=com.redhat.consulting.vertx -DprojectArtifactId=homeplan -Dverticle=com.redhat.consulting.vertx.MainVerticle -Ddependencies=web
----

    - Inspect *_MainVerticle.java_* and the AbstractVerticle to identify getting access to the Vertx instance
    - Start the Vert.x eventloop locally with the following command and check the logs to ensure the Verticle has been successfully started

[source,perl]
----
mvn compile vertx:run
----

    - Make a change on *_MainVerticle.java_* and press 'Save'. You will see in the command line the *_vertx-maven-plugin_* fabric8 plugin redeploying the verticle
    - Review the possible configurations https://vmp.fabric8.io/#common:configurations and run configurations https://vmp.fabric8.io/#common:run-configurations via the *_vertx-maven-plugin_* 


====  STEP 2 In this step you will create an HTTP server and expose *_homeplan_* service endpoints
* Use resources at http://vertx.io/docs/vertx-web/java/[Vert.x Web] to create an HTTP server so that it exposes the services in port 8181 in the *_start()_* method of the *_MainVerticle.java_*
  ** As a final step expose a "Hello World" message on a GET request to the *_'/'_* path of the HTTP server
  ** *TEST* After the Verticle Redeployment hit http://127.0.0.0:8181/ and you should see "Hello World" returned
* Add new class Constants with the following content to be used later in this lab

----
     public class Constants {

	// Rest
	//public static final String ROOT_PATH = "/homeplan";
	public static final String ROOT_PATH = "/";
	public static final String ID_PARAM = "id";
	// Share data
	public static final String HOMEPLANS_MAP = "homeplans";
	public static final String HOMEPLAN_IDS_MAP = "homeplan-ids";
	public static final String SET_ID = "index-set-id";
	// Addresses
	public static final String DEVICE_REGISTRATION_EVENTS_ADDRESS = "device-reg";
	public static final String HOMEPLANS_EVENTS_ADDRESS = "homeplans";
	public static final String DEVICE_DATA_EVENTS_ADDRESS = "device-data";
     }
----


* Add logging into the *_MainVerticle.java_* choosing the *_io.vertx.core.*;_* logging imports
   
[source,perl]
----
private final Logger logger = LoggerFactory.getLogger(MainVerticle.class);
----

* Create a member variable to hold submitted Homeplans 
      
[source,perl]
----
private Map<String, String> homeplans= new HashMap<String, String>();
---- 

* Use resources at http://vertx.io/docs/vertx-web/java/[Vert.x Web]  and implement the following REST endpoints on the HTTP Server created previously
      ** Expose a *GET* operation on endpoint *_/homeplan_* to be handled by the method *_getAll_* (provided for you in the following code snipet) to retrieve all registerd homeplan IDs

[source,perl]
----
    private void getAll(RoutingContext routingContext) {
    	logger.info("Getting all homeplan ids available");

    	if (homeplans.keySet().size() != 0){
    		logger.info("Returning Homeplan IDs ", Json.encodePrettily(homeplans.keySet()));
        	routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
        	.end(Json.encodePrettily(homeplans.keySet()));
    	} else {
    		logger.info("No Homeplans Registered as yet");
        	routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
        	.end(Json.encodePrettily("No Homeplans Registered as yet"));
    	}
    }
----

*TEST*

[source,perl]
----
mvn compile vertx:run

On a browser
http://127.0.0.0:8181/homeplan
----
       
      ** Expose a *GET* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_getOne_* (provided for you in the following code snipet) returning the contents of a single HomePlan (Note: utilize Constants.ID_PARAM)

[source,perl]
----
    private void getOne(RoutingContext routingContext) {
    	if (homeplans.get(routingContext.pathParam(Constants.ID_PARAM)) != null) {
    		routingContext.response().putHeader("content-type", "application/json; charset=utf-8")
    		.end(Json.encodePrettily(homeplans.get(routingContext.pathParam(Constants.ID_PARAM))));
    	} else {
    		routingContext.fail(404);
    	}
    
----

*TEST*

[source,perl]
----
mvn compile vertx:run

On a browser
http://127.0.0.0:8181/homeplan/KousourisHouseplan
----

      ** Expose a *POST* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_getOne_* (provided for you in the following code snipet) registering a single HomePlan

[source,perl]
----
    private void addOne(RoutingContext routingContext) {
    	final String homeplanId = routingContext.pathParam(Constants.ID_PARAM);
    	final String homePlan = routingContext.getBodyAsString();
	
    	homeplans.put(homeplanId, homePlan);

    	logger.info("Registering Homeplan ["+homeplanId+"] with content ["+homePlan+"]");
    	
    	logger.info("Sending event to address #{0} to register devices", Constants.DEVICE_REGISTRATION_EVENTS_ADDRESS);
    	
    	routingContext.response().setStatusCode(201)
		.putHeader("content-type", "application/json; charset=utf-8")
		.end(Json.encodePrettily(homePlan));
    }
----

*TEST*


----
mvn compile vertx:run
curl -H "Content-Type: application/json" -X POST -d '@sanchoA.json'  http://127.0.0.1:8181/homeplan/Sancho

sanchoA.json CONTENTS
{ "SanschoHomePlan" : [{ "sensorLocations" : ["kitchen", "kitchen-1", "22"], "devices" : ["AIRCON", "kitchen-1"]}, { "sensorLocations" : ["bedroom", "bedroom-1", "23"], "devices" : ["AIRCON", "bedroom-1"]}]}

----

      ** Expose a *PUT* operation on endpoint *_/homeplan/{id}_* to be handled by the method *_addOne_* (provided for you in the above code snipet) updating a single HomePlan

*TEST*

----
mvn compile vertx:run
curl -H "Content-Type: application/json" -X PUT -d '@sanchoB.json'  http://127.0.0.1:8181/homeplan/Sancho

testB.json CONTENTS
{ "SanschoHomePlan" : [{ "sensorLocations" : ["kitchen", "kitchen-1", "30"], "devices" : ["AIRCON", "kitchen-1"]}, { "sensorLocations" : ["bedroom", "bedroom-1", "33"], "devices" : ["AIRCON", "bedroom-1"]}]}
----
      



====  STEP 3 Threading, Event Loop instances

* Deploy multiple Verticles by way of command line http://vertx.io/docs/vertx-core/java/#_run_verticles[configuration] *-Dvertx.runArgs="--instances=2"* 
* Once the Vert.x application is running add in each of the HTTP helper methods

----
String eventLoopID = "[EVENT LOOP ID - "+this.toString()+"]";

and prepend each HTTP response with the eventLoopID

Json.encodePrettily(eventLoopID+...
----

* Complete the following tests
  ** Repeat the GET /homeplan request multiple times and see the EventLoop that services it
  ** Repeat the POST & PUT /homeplan/{id} multiple times and see the EventLoop that services it
  ** Do you notice a difference? 
  ** Now execute the GET /homeplan/{id} and report the findings and why there is a difference in each executin

* Use the http://vertx.io/docs/vertx-core/java/#_verticles[Launcher] to manage instances via DeploymentOptions etc.



